<!DOCTYPE html>
<html>
    <head>
        <title>6 Practice Trials</title>
        <script src='jatos.js'></script>
        <script src='./jspsych-6.1.0/jspsych.js'></script>        
        <script src='./extra_functions/lodash.js'></script>
        <script src = './extra_functions/jquery-3.4.1.js' type='text/javascript'></script>
        <script src='./extra_functions/jspsych-plugin-playground.js'></script>
        <link href='./jspsych-6.1.0/css/jspsych.css' rel='stylesheet' type='text/css'></link>
    </head>
    <body style="background-color:#99a3a4;"></body>
    <script>

        jatos.onLoad(function() {


            // Get the trials for this session
            let curr_phase   = jatos.studySessionData.phase_counter
            let curr_session = jatos.studySessionData.session_counter['phase_'+curr_phase]

            var session_trials         = jatos.studySessionData.inputData.practice_trials['phase_'+curr_phase]
            let curr_space_object      = jatos.studySessionData.inputData.concepts['phase_'+curr_phase]
            let score_box_target_names = jatos.studySessionData.inputData.score_box_target_names['phase_'+curr_phase]

            let n_trials = session_trials.length

            // Record the current trial array in the outputData variable
            jatos.studySessionData.outputData['phase_'+curr_phase+'_practice_results'] = session_trials

            // //////////// PLUGIN INPUT //////////////////////////////
            var session_procedure = {
                timeline: [
            
                    {
                        type: 'plugin-playground',
                
                        prompt_img_name: jsPsych.timelineVariable('prompt_img_name'),
                        prompt_img_path: jsPsych.timelineVariable('prompt_img_path'),
                        prompt_img_width: jatos.studySessionData.inputData.basic_parameters.prompt_target_width,
                        prompt_img_height: jatos.studySessionData.inputData.basic_parameters.prompt_target_height,
                        prompt_img_x_coords: jatos.studySessionData.inputData.basic_parameters.prompt_img_x_coords,
                        prompt_img_y_coords: jatos.studySessionData.inputData.basic_parameters.prompt_img_y_coords,
                        
                        ex_pairs_img_path:    jsPsych.timelineVariable('ex_pairs_img_path'),
                        ex_pairs_img_width:  curr_space_object.ex_pairs_img_width,
                        ex_pairs_img_height: curr_space_object.ex_pairs_img_height,
                        ex_pairs_maintain_aspect_ratio: true,

                        onscreen_idx: ['1','2'],
                        onscreen_idx_x_coords: curr_space_object.onscreen_idx_x_coords,
                        onscreen_idx_y_coords: curr_space_object.onscreen_idx_y_coords,                    
                                            
                        fb_correct_img: jatos.studySessionData.inputData.basic_parameters.fb_correct_img,
                        fb_incorrect_img: jatos.studySessionData.inputData.basic_parameters.fb_incorrect_img,

                        audio_stimulus: jatos.studySessionData.inputData.basic_parameters.audio_stimulus,

                        fb_img_paths: jsPsych.timelineVariable('item_img_paths'),
                        item_img_names: jsPsych.timelineVariable('item_img_names'),             

                        fb_imgs_x_coords: curr_space_object.fb_imgs_x_coords,
                        fb_imgs_y_coords: curr_space_object.fb_imgs_y_coords,                    

                        score_box_target_names: score_box_target_names,

                        sort_area_width: 750,
                        sort_area_height: 700,
                        prompt: 'Which of the two pictures below are associated with this Christmas toy?',
                        choices: ['1', '2'],
                        response_ends_trial: true,
                        timer_till_fb:           jatos.studySessionData.inputData.basic_parameters.timer_till_fb,
                        timer_after_response:    jatos.studySessionData.inputData.basic_parameters.timer_after_response,
                        timer_no_resp_fb_freeze: jatos.studySessionData.inputData.basic_parameters.timer_no_resp_fb_freeze,
                        timer_response_window:   jatos.studySessionData.inputData.basic_parameters.timer_response_window,
                        post_trial_gap: 500,
                        correct_response: jsPsych.timelineVariable('prompt_item_idx'),
                        
                        n_trials: n_trials,
                        phase: jsPsych.timelineVariable('phase'),
                        session: jsPsych.timelineVariable('session'),                        
                    }
                ],

                timeline_variables: session_trials
            };

            jsPsych.init({
                timeline: [session_procedure],
                use_webaudio: false,
                // preload_images: imgs_to_load,

                on_finish: function(data) {
                    
                    // Make JATOS remember that this session was run
                    jatos.studySessionData.latestFinishedComponentId  = jatos.componentId;
                    jatos.studySessionData.latestFinishedComponentPos = jatos.componentPos;
                    jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;

                    debugger

                    // submit results to JATOS
                    output_trial_data = jsPsych.data.get().values();

                    // Combine it with trial information
                    for (iT=0; iT<output_trial_data.length; iT++){
                        jatos.studySessionData.outputData['phase_'+jatos.studySessionData.phase_counter+'_practice_results'][iT] = 
                            Object.assign(jatos.studySessionData.outputData['phase_'+jatos.studySessionData.phase_counter+'_practice_results'][iT],
                                          output_trial_data[iT])

                    }


                    debugger

                    if (!jatos.studySessionData.repeat){
                        jatos.studySessionData.allData.session_results[jatos.studySessionData.session_counter - 1][0] = result_data;
                    } else {
                        jatos.studySessionData.allData.session_results[jatos.studySessionData.session_counter - 1][jatos.studySessionData.allData.session_results[jatos.studySessionData.session_counter - 1].length] = result_data;
                    };

                    // Create a temporary variable to hold data of the latest run session, so qc can be performed on this
                    jatos.studySessionData.last_session_data = 
                    JSON.parse(JSON.stringify(jatos.studySessionData.allData.session_results[jatos.studySessionData.session_counter - 1]));

                    // debugger;

                    jatos.submitResultData("[ses_" + jatos.studySessionData.session_counter + "_start---" + 
                    JSON.stringify(jatos.studySessionData) +  
                    "---ses_" + jatos.studySessionData.session_counter + "_end]", function(){
                        jatos.startComponentByPos(jatos.studySessionData.script_comp_ids.qc_checks);
                    });
                } 
                
                // on_finish: function(data) {
                //     console.log('Over');
                //     jsPsych.data.displayData('json');
                // }       
            });
   
            // ///////////////////////////////////////////////////////////////////////////////////////////////
            //////////////////////////////////////////////////////////////////////////////////////////////////
        });
    
    </script>
</html>
