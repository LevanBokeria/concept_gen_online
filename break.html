<!doctype html>
<html lang="en">
  <head>
	<title>Break</title>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0">
	<script src="jspsych-6.1.0/jspsych.js" ></script>
	<script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
	<script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
	<script src="jatos.js"></script>
	<script src="./extra_functions/jspsych-instructions-timer.js"></script>
	<script src='./extra_functions/helper_functions.js'></script>
	<link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css" type="text/css"></link>
	
	<style>	body {background-color: #b9c6c7; font-family: sans-serif; color: black;} </style>
	<style> p {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px;} </style>
	<style> ul {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px; cursor:default;} </style>
	<style> .instruct{width:100%; color: black; text-align:center; cursor:default;} </style>
	<style> .header {position: fixed; left:0; top:0; width:100%; background-color:#8f8d8d; color: white; text-align: center;cursor:default;} </style>
  </head>

  <body>
  <script>

	// /////////////////////////////// HELPER FUNCTIONS ////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////
	const createPhaseDebriefer = function(){
        let phase_questions = {
            type: 'survey-text',
			questions: [
                {prompt: 'How did you learn which ' + curr_concept.concept_object + ' was hiding which toy? Did you have any strategy?', rows: 3, columns: 100},
                {prompt: 'Did you make any drawings or take any screenshots or pictures ' + 
                'to help remember which of the '+curr_concept.concept_object+' were hiding which toys? <br>(you will not be penalised if you did, we just need to know so we can correctly analyze the data)', rows: 3, columns: 100},
                ],
			button_label: 'Continue',
			preamble: '<p style="font-size: 30px;"><b>Phase '+curr_phase+' debriefing about the birds:</b></p>',
		};    
		
		return phase_questions
	};

	const createSpatialLayoutDebriefer = function(iPhase,iConcept){

        let spatialLayoutImgEl           = document.createElement('img')
        spatialLayoutImgEl.src           = './img/' + iConcept.concept_space + '/2d_space.png'
        spatialLayoutImgEl.id            = '2d_layout'
        spatialLayoutImgEl.style.height  = '300px'
        spatialLayoutImgEl.style.width   = '300px'
        spatialLayoutImgEl.style.padding = '20px'

        let spatial_questions = [
                {prompt: 'At any point during the experiment, did you realize that the all the '+ iConcept.concept_object + ' you saw with different ' + 
                'sizes of '+ iConcept.dim1_name + ' and '+ iConcept.dim2_name + ', <br>can be represented in a 2-dimensional space as depicted above? ' +
                ' <br>Each '+ iConcept.concept_object + ' is a point in this space, and the value on each dimension specifies the sizes of '+ iConcept.dim1_name + ' and '+ iConcept.dim2_name + '? ' + 
                '<br> If you did realize this, did this help you in learning the '+ iConcept.concept_object + '-toy associations?', rows: 3, columns: 100, placeholder: ''},            
            ]
        let spatial_preamble = '<p style="font-size: 30px;"><b> Phase '+ iPhase + ' debriefing about the '+ iConcept.concept_object + ':</b></p>'

        let spatialLayoutTrial = createImageSurveyTrial(spatial_preamble,[spatialLayoutImgEl],spatial_questions)
	};




	////////////////////////////////////////////////////////////////////////////////////////

	//start timeline
	jatos.onLoad(function() {

		// What phase is this?
		let [curr_phase,phase_string,curr_session] = getPhaseAndSession()

		let trial_dur_sec = jatos.studySessionData.timer_response_window / 1000
		let curr_concept  = jatos.studySessionData.inputData.concepts[phase_string].concept_object

		// Create the score box
		let score_box_element = createScoreBox()
		score_box_element.style.margin = '0 auto'

		let component_to_start

		debugger

		//make a timeline
		var timeline = []; 

		// Generic message saying "sorry you failed QC". Will then be followed by appropriate debriefing pages, and data submission
		var qc_failed_generic = {

			type: 'survey-text',
			questions: jatos.studySessionData.debrief_questions,
			button_label: 'Finish',
			preamble: '<p> <br> Unfortunately, your performance did not pass our quality checks. </p> ' + 
				'<p> As we stated in the instructions, in such a case we have to discontinue the study. </p>' +
				'<p> You will still be paid for the sections of the experiment you performed. </p> ' + 
				'<p> But first, please complete the debriefing survey by clicking the "Continue" button.</p>'
		};

		// Generic questions to ask regardless of where the ptp failed, or if the ptp succeeded
        var general_questions = {
            type: 'survey-text',
			questions: [
                {prompt: 'Were the game instructions clear? If not, please help us improve them.', rows: 3, columns: 100},
                {prompt: 'Was the number of toys you had to "find" too high? Should we make it less or more?', rows: 3, columns: 100},
                {prompt: 'Were '+ trial_dur_sec +' seconds enough on each trial to make your choice and learn from feedback?', rows: 3, columns: 100},
                {prompt: 'Did you complete the experiment in fullscreen mode? (You will not be penalised if you did not. We just need to know).', rows: 3, columns: 100},
                {prompt: 'Is there anything that would make the game easier or more fun?', rows: 3, columns: 100},                
                ],
			button_label: 'Continue',
			preamble: '<p style="font-size: 30px;"><b>Please answer the following questions:</b></p>',
		};		
		
		// Questions to ask for any specific phase
			// Phase 1
			var phase_1_questions = createPhaseDebriefer()
			// Phase 2
			var phase_2_questions = createPhaseDebriefer()
			// Phase 3
			var phase_3_questions = createPhaseDebriefer()


		// Element asking about the spatial layout.
			// Phase 1
			var phase_1_spatial = createSpatialLayoutDebriefer(1,jatos.studySessionData.inputData.concepts.phase_1)
			// Phase 2
			var phase_2_spatial = createSpatialLayoutDebriefer(2,jatos.studySessionData.inputData.concepts.phase_2)
			// Phase 3
			var phase_3_spatial = createSpatialLayoutDebriefer(3,jatos.studySessionData.inputData.concepts.phase_3)


		// In case they failed qc
		var qc_failed_phase_1 = {

			type: 'survey-text',
			questions: jatos.studySessionData.debrief_questions,
			button_label: 'Finish',
			preamble: '<p> Unfortunately, your performance did not pass our quality checks. </p> ' + 
					'<p> As we stated in the instructions, in such a case we have to discontinue the study. </p>' +
					'<p> You will still be paid for the practice session and any completed experimental session.</p> ' + 
					'<p> But first, please answer the following questions and then click the "Finish" button below.</p>'

		};  

		var qc_failed_phase_2 = {

			type: 'survey-text',
			questions: jatos.studySessionData.debrief_questions,
			button_label: "Finish",
			preamble: "<p> Unfortunately, your performance did not pass our quality checks. </p> " + 
					"<p> As we stated in the instructions, in such a case we have to discontinue the study. </p>" +
					"<p> You will still be paid for the practice session and any completed experimental session.</p> " + 
					"<p> But first, please answer the following questions and then click the 'Finish' button below.</p>"

		};      

		var short_break_trial = {
			type: 'instructions-timer',
			pages: [
				'<p> Thank you so much for completing this session! <br> ' + 
				'We really appreciate you staying attentive and continuing to honestly perform the task. </p>' +
				'<p> Below you can see your scores from the last session: </p>' +
				score_box_element.outerHTML + 
				'<p> <br>Remember, you goal is to reach ' + 
					jatos.studySessionData.training_criterion + '% on finding each of these toys!' +
				'<p><br> Please take a ' + jatos.studySessionData.short_break_duration + 
				' second break and click the Next button or press the right-arrow button on the keyboard to start the next session. </p>'
			],
			show_clickable_nav: true,
			button_label_next: "<span style='color: blue';> <strong> Next </stong></span>",
			n_seconds: jatos.studySessionData.short_break_duration

		};

		var long_break_trial = {
			type: 'instructions-timer',
			pages: [
				'<p> Congratulations! You have finished phase ' + curr_phase + ' of the game! </p>' + 
				'<p> Below you can see your finishing scores for phase ' + curr_phase + ': </p>' +
				score_box_element.outerHTML + 
				'<p> Please take a break, and then click the Next button to read instructions for phase ' + 
				(curr_phase+1) + '!</p>' +
				'<p> Thank you very much for staying attentive! </p>'
			],
			show_clickable_nav: true,
			button_label_next: "<span style='color: blue';> <strong> Next </stong></span>",
			n_seconds: jatos.studySessionData.long_break_duration

		};

		if (jatos.studySessionData.progress_state == 'advance_phase') {
			timeline.push(long_break_trial)

			jatos.studySessionData.phase_counter ++

			component_to_start = jatos.studySessionData.script_comp_pos.instructions

		} else if (jatos.studySessionData.progress_state == 'advance_session'){
			timeline.push(short_break_trial)
			jatos.studySessionData.session_counter[phase_string] ++			

			component_to_start = jatos.studySessionData.script_comp_pos.phase_pa

		} else if (jatos.studySessionData.progress_state == 'qc_failed_phase_1'){			
			timeline.push(qc_failed_phase_1)

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission

		} else if (jatos.studySessionData.progress_state == 'qc_failed_phase_2'){		
			timeline.push(qc_failed_phase_2)	

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission

		} else if (jatos.studySessionData.progress_state == 'qc_failed_phase_3'){		
			timeline.push(qc_failed_phase_3)	

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission


		} else if (jatos.studySessionData.progress_state == 'finished_training'){
			timeline.push(finished_training) // not yet defined

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission
		}		

		jsPsych.init({

			timeline: timeline,

			on_finish: function() {

				jatos.studySessionData.outputData[phase_string + '_breaks_results'][
					jatos.studySessionData.outputData[phase_string + '_breaks_results'].length
				] = jsPsych.data.get().values();

				jatos.submitResultData("[break_start---" + 
				JSON.stringify(jatos.studySessionData) + 
				"---break_end]", function(){
					jatos.startComponentByPos(component_to_start);
				});
			}
		});

	});

	</script>
</body>
</html>