<!doctype html>
<html lang="en">
  <head>
	<title>Break</title>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0">
	<script src="jspsych-6.1.0/jspsych.js" ></script>
	<script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
	<script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
	<script src="jatos.js"></script>
	<script src="./extra_functions/jspsych-instructions-timer.js"></script>
	<script src='./extra_functions/custom_functions.js'></script>
	<link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css" type="text/css"></link>
	
	<style>	body {background-color: #b9c6c7; font-family: sans-serif; color: black;} </style>
	<style> p {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px;} </style>
	<style> ul {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px; cursor:default;} </style>
	<style> .instruct{width:100%; color: black; text-align:center; cursor:default;} </style>
	<style> .header {position: fixed; left:0; top:0; width:100%; background-color:#8f8d8d; color: white; text-align: center;cursor:default;} </style>
  </head>

  <body>
  <script>

	//start timeline
	jatos.onLoad(function() {

		// What phase is this?
		let [curr_phase,phase_string,curr_session] = getPhaseAndSession()

		// Create the score box
		let score_box_element = createScoreBox()
		score_box_element.style.margin = '0 auto'

		let component_to_start

		debugger

		//make a timeline
		var timeline = []; 

		// In case the ptp failed qc after phase 1 practice
		var qc_failed_practice = {

			type: 'survey-text',
			questions: jatos.studySessionData.debrief_questions,
			button_label: "Finish",
			preamble: "<p> <br> Unfortunately, your performance did not pass our quality checks. </p> " + 
				"<p> As we stated in the instructions, in such a case we have to discontinue the study. </p>" +
				"<p> You will still be paid 1.2 pounds for completing the instructions and the practice session. </p> " + 
				"<p> But first, please answer the following questions and then click the 'Finish' button below.</p>"
		};

		// In case they failed qc
		var qc_failed_phase_1 = {

			type: 'survey-text',
			questions: jatos.studySessionData.debrief_questions,
			button_label: "Finish",
			preamble: "<p> Unfortunately, your performance did not pass our quality checks. </p> " + 
					"<p> As we stated in the instructions, in such a case we have to discontinue the study. </p>" +
					"<p> You will still be paid for the practice session and any completed experimental session.</p> " + 
					"<p> But first, please answer the following questions and then click the 'Finish' button below.</p>"

		};  

		var qc_failed_phase_2 = {

			type: 'survey-text',
			questions: jatos.studySessionData.debrief_questions,
			button_label: "Finish",
			preamble: "<p> Unfortunately, your performance did not pass our quality checks. </p> " + 
					"<p> As we stated in the instructions, in such a case we have to discontinue the study. </p>" +
					"<p> You will still be paid for the practice session and any completed experimental session.</p> " + 
					"<p> But first, please answer the following questions and then click the 'Finish' button below.</p>"

		};      

		var short_break_trial = {
			type: 'instructions-timer',
			pages: [
				'<p> Thank you so much for completing this session! <br> ' + 
				'You are doing great! <br> ' +
				'We really appreciate you staying attentive and continuing to honestly perform the task. </p>' +
				'<p> Below you can see your scores from the last session: </p>' +
				score_box_element.outerHTML + 
				'<p> <br>Remember, you goal is to reach ' + 
					jatos.studySessionData.training_criterion + '% on each of these toys!' +
				'<p><br> Please take a ' + jatos.studySessionData.short_break_duration + 
				' second break and click the Next button or press the right-arrow button on the keyboard to start the next session. </p>'
			],
			show_clickable_nav: true,
			button_label_next: "<span style='color: blue';> <strong> Next </stong></span>",
			n_seconds: jatos.studySessionData.short_break_duration

		};

		var long_break_trial = {
			type: 'instructions-timer',
			pages: [
				'<p> Congratulations! You have finished learning the associations for phase 1! </p>' + 
				'<p> Please take a break, and then click the Next button to read instructions for phase 2!</p>' +
				'<p> Thank you very much for staying attentive! </p>'
			],
			show_clickable_nav: true,
			button_label_next: "<span style='color: blue';> <strong> Next </stong></span>",
			n_seconds: jatos.studySessionData.long_break_duration

		};

		if (jatos.studySessionData.progress_state == 'advance_phase') {
			timeline.push(long_break_trial)

			jatos.studySessionData.phase_counter ++

			component_to_start = jatos.studySessionData.script_comp_pos.instructions

		} else if (jatos.studySessionData.progress_state = 'advance_session'){
			timeline.push(short_break_trial)
			jatos.studySessionData.session_counter[phase_string] ++			

			component_to_start = jatos.studySessionData.script_comp_pos.phase_pa

		} else if (jatos.studySessionData.progress_state = 'qc_failed_phase_1'){			
			timeline.push(qc_failed_phase_1)

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission

		} else if (jatos.studySessionData.progress_state = 'qc_failed_phase_2'){		
			timeline.push(qc_failed_phase_2)	

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission

		} else if (jatos.studySessionData.progress_state = 'finished_training'){
			timeline.push(finished_training) // not yet defined

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission
		}		

		jsPsych.init({

			timeline: timeline,

			on_finish: function() {

				jatos.studySessionData.outputData[phase_string + '_breaks_results'][
					jatos.studySessionData.outputData[phase_string + '_breaks_results'].length
				] = jsPsych.data.get().values();

				jatos.submitResultData("[break_start---" + 
				JSON.stringify(jatos.studySessionData) + 
				"---break_end]", function(){
					jatos.startComponentByPos(component_to_start);
				});
			}
		});

	});

	</script>
</body>
</html>