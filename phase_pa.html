<!DOCTYPE html>
<html>
    <head>
        <title>Phase PA</title>
        <script src='jatos.js'></script>
        <script src='./jspsych-6.1.0/jspsych.js'></script>        
        <script src='./extra_functions/lodash.js'></script>
        <script src = './extra_functions/jquery-3.4.1.js' type='text/javascript'></script>
        <script src='./extra_functions/jspsych-plugin-playground.js'></script>
        <script src="./extra_functions/helper_functions.js"> </script>
        <link href='./jspsych-6.1.0/css/jspsych.css' rel='stylesheet' type='text/css'></link>
    </head>
    <body style="background-color:#99a3a4;"></body>
    <script>

        jatos.onLoad(function() {
            
            // debugger

            // What phase is this?
            let curr_phase             = jatos.studySessionData.phase_counter
            let phase_string           = 'phase_'+curr_phase
            let curr_session           = jatos.studySessionData.session_counter[phase_string]
            let curr_space_object      = jatos.studySessionData.inputData.concepts[phase_string]

            // Reset the running performance
            jatos.studySessionData.inputData.running_perf[phase_string] = 
                new Array(jatos.studySessionData.inputData.basic_parameters.nTargets).fill(0)

            // If this for practice run?
            if (jatos.componentProperties.title.includes('practice_trials')){

                // Generate a full array of trials for a full session
                var session_trials = 
                    trialCreator(jatos.studySessionData.inputData.concepts[phase_string],
                                jatos.studySessionData.inputData.baseTrialArray[phase_string],
                                jatos.studySessionData.inputData.basic_parameters,
                                curr_phase,0)     

                

                // Now, choose trials such that each item is used at least twice
                var practice_session_trials = []
                
                for (iPointName of jatos.studySessionData.inputData.basic_parameters.targetPointNames[phase_string]){
                    // Find trials with this target
                    session_trials.map(item => {
                        if(item.prompt_point_name == iPointName){
                            practice_session_trials.push(item)
                        }
                    })
                }
                // Shuffle practice_session_trials
                session_trials = deepCopy(shuffle(practice_session_trials))

                // Now slice it
                session_trials = session_trials.slice(0,jatos.studySessionData.n_practice_trials)

                // Record the current trial array in the outputData variable
                jatos.studySessionData.outputData[phase_string+'_practice_results'] = session_trials
            } else {
                // Then, check which session this is
                var session_trials = 
                    trialCreator(jatos.studySessionData.inputData.concepts[phase_string],
                                jatos.studySessionData.inputData.baseTrialArray[phase_string],
                                jatos.studySessionData.inputData.basic_parameters,
                                curr_phase,curr_session)

                // Record the current trial array in the outputData variable
                jatos.studySessionData.outputData[phase_string+'_results'][curr_session-1] = session_trials                 
            } 
            let n_trials = session_trials.length           

            // debugger

            let imgs_to_preload = deepCopy(jatos.studySessionData.inputData.imgs_to_preload)

            imgs_to_preload.exemplar_images = session_trials.map((item) => {
                return item.ex_pairs_img_path
            })
            
            imgs_to_preload.exemplar_images = 
                imgs_to_preload.exemplar_images.concat(jatos.studySessionData.inputData.basic_parameters.targetPathsUsed[phase_string])

            // //////////// PLUGIN INPUT //////////////////////////////
            var session_procedure = {
                timeline: [
            
                    {
                        type: 'plugin-playground',
                
                        prompt_img_name:     jsPsych.timelineVariable('prompt_img_name'),
                        prompt_img_path:     jsPsych.timelineVariable('prompt_img_path'),
                        prompt_img_width:    jatos.studySessionData.inputData.basic_parameters.prompt_target_width,
                        prompt_img_height:   jatos.studySessionData.inputData.basic_parameters.prompt_target_height,
                        prompt_img_x_coords: jatos.studySessionData.inputData.basic_parameters.prompt_img_x_coords,
                        prompt_img_y_coords: jatos.studySessionData.inputData.basic_parameters.prompt_img_y_coords,
                        
                        ex_pairs_img_path:   jsPsych.timelineVariable('ex_pairs_img_path'),
                        ex_pairs_img_width:  curr_space_object.ex_pairs_img_width,
                        ex_pairs_img_height: curr_space_object.ex_pairs_img_height,
                        ex_pairs_maintain_aspect_ratio: true,

                        onscreen_idx: ['1','2'],
                        onscreen_idx_x_coords: curr_space_object.onscreen_idx_x_coords,
                        onscreen_idx_y_coords: curr_space_object.onscreen_idx_y_coords,                    
                                            
                        fb_correct_img:   jatos.studySessionData.inputData.basic_parameters.fb_correct_img,
                        fb_incorrect_img: jatos.studySessionData.inputData.basic_parameters.fb_incorrect_img,

                        audio_stimulus: jatos.studySessionData.inputData.basic_parameters.audio_stimulus,

                        fb_img_paths:   jsPsych.timelineVariable('item_img_paths'),
                        item_img_names: jsPsych.timelineVariable('item_img_names'),             

                        fb_imgs_x_coords: curr_space_object.fb_imgs_x_coords,
                        fb_imgs_y_coords: curr_space_object.fb_imgs_y_coords,                    

                        sort_area_width:          750,
                        sort_area_height:         700,
                        prompt:                  'Which of the two pictures below are associated with this Christmas toy?',
                        choices:                 jatos.studySessionData.inputData.choices,
                        response_ends_trial:     true,
                        timer_after_response:    jatos.studySessionData.timer_after_response,
                        timer_no_resp_fb_freeze: jatos.studySessionData.timer_no_resp_fb_freeze,
                        timer_response_window:   jatos.studySessionData.timer_response_window,
                        post_trial_gap:          jatos.studySessionData.post_trial_gap,
                        correct_response:        jsPsych.timelineVariable('prompt_item_idx'),
                        
                        n_trials:  n_trials,
                        phase:     jsPsych.timelineVariable('phase'),
                        session:   jsPsych.timelineVariable('session'),     
                        on_finish: function(data){
                            calcRunningPerf(data)
                        }                                                             
                    }
                ],

                timeline_variables: session_trials
            };

            jsPsych.init({
                timeline: [session_procedure],
                use_webaudio: false,
                preload_images: [...imgs_to_preload.base_images, ...imgs_to_preload.exemplar_images],

                on_finish: function(data) {
                    
                    // What phase is this?
                    let curr_phase             = jatos.studySessionData.phase_counter
                    let phase_string           = 'phase_'+curr_phase
                    let curr_session           = jatos.studySessionData.session_counter[phase_string]

                    // Make JATOS remember that this session was run
                    jatos.studySessionData.latestFinishedComponentId    = jatos.componentId;
                    jatos.studySessionData.latestFinishedComponentPos   = jatos.componentPos;
                    jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;

                    // submit results to JATOS
                    output_trial_data = jsPsych.data.get().values();
                    // debugger
                    // Combine it with pre-existing trial information
                    if (jatos.componentProperties.title.includes('practice_trials')){
                        for (iT=0; iT<output_trial_data.length; iT++){
                            jatos.studySessionData.outputData[phase_string+'_practice_results'][iT] = 
                                Object.assign(jatos.studySessionData.outputData[phase_string+'_practice_results'][iT],
                                            output_trial_data[iT])
                        }

                        // Create a temporary variable to hold data of the latest run session, so qc can be performed on this
                        jatos.studySessionData.last_session_data = 
                        deepCopy(jatos.studySessionData.outputData[phase_string+'_practice_results']);

                        var results_delimiter_start = "[phase_" + curr_phase + "_practice_start---"
                        var results_delimiter_end   = "---phase_" + curr_phase + "_practice_end]"                        

                    } else {
                        for (iT=0; iT<output_trial_data.length; iT++){
                            jatos.studySessionData.outputData[phase_string+'_results'][curr_session-1][iT] = 
                                Object.assign(jatos.studySessionData.outputData[phase_string+'_results'][curr_session-1][iT],
                                            output_trial_data[iT])
                        }

                        // Create a temporary variable to hold data of the latest run session, so qc can be performed on this
                        jatos.studySessionData.last_session_data = 
                        deepCopy(jatos.studySessionData.outputData[phase_string+'_results'][curr_session-1]);                        

                        var results_delimiter_start = "[phase_" + curr_phase + "_ses_" + curr_session + "_start---"
                        var results_delimiter_end   = "---phase_" + curr_phase + "_ses_" + curr_session + "_end]" 
                    }

                    // debugger

                    jatos.submitResultData(
                        results_delimiter_start + 
                        JSON.stringify(jatos.studySessionData) +  
                        results_delimiter_end, function(){
                            jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.intermediate_feedback);
                        }
                    );
                } 
                
                // on_finish: function(data) {
                //     console.log('Over');
                //     jsPsych.data.displayData('json');
                // }       
            });
   
            // ///////////////////////////////////////////////////////////////////////////////////////////////
            //////////////////////////////////////////////////////////////////////////////////////////////////
        });
    
    </script>
</html>
