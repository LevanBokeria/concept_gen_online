<!doctype html>
<html lang="en">
  <head>
	<title>Transition</title>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0">
	<script src="jspsych-6.1.0/jspsych.js" ></script>
	<script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
	<script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
	<script src='./jspsych-6.1.0/plugins/jspsych-survey-html-form.js'></script>
	<script src="jatos.js"></script>
	<script src="./extra_functions/jspsych-instructions-timer.js"></script>
	<script src='./extra_functions/helper_functions.js'></script>
	<link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css" type="text/css"></link>
	
	<style>	body {background-color: #b9c6c7; font-family: sans-serif; color: black;} </style>
	<style> p {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px;} </style>
	<style> ul {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px; cursor:default;} </style>
	<style> .instruct{width:100%; color: black; text-align:center; cursor:default;} </style>
	<style> .header {position: fixed; left:0; top:0; width:100%; background-color:#8f8d8d; color: white; text-align: center;cursor:default;} </style>
	<style> .score_box p {font-size: 14px }</style>
  </head>

  <body>
  <script>

	//start timeline
	jatos.onLoad(function() {
		
		// /////////////////////////////// HELPER FUNCTIONS ////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////////
		const createPhaseDebriefer = function(iPhase,iConcept){
			let phase_debriefer = {
				type: 'survey-text',
				questions: [
					{prompt: 'How did you learn which ' + iConcept.concept_object + ' was hiding which toy? Did you have any strategy for memorizing?', rows: 3, columns: 100},
					{prompt: 'Did you make any drawings or take any screenshots or pictures ' + 
					'to help remember which '+iConcept.concept_object+' was hiding which toy? <br>(you will not be penalised if you did, we just need to know so we can correctly analyze the data)', rows: 3, columns: 100},
					],
				button_label: 'Continue',
				preamble: '<p style="font-size: 30px;"><b>Phase '+iPhase+' debriefing about the '+ iConcept.concept_object +'s with '+iConcept.dim1_name+' and '+iConcept.dim2_name +' :</b></p>',
				data: {test_part: 'phase_' + iPhase + '_debriefer'},
			};    
			
			return phase_debriefer
		};

		const createSpatialLayoutDebriefer = function(iPhase,iConcept){

			let spatialLayoutImgEl           = document.createElement('img')
			spatialLayoutImgEl.src           = './img/' + iConcept.concept_space + '/2d_space.png'
			spatialLayoutImgEl.id            = '2d_layout'
			spatialLayoutImgEl.style.height  = '300px'
			spatialLayoutImgEl.style.width   = '300px'
			spatialLayoutImgEl.style.padding = '20px'

			let spatial_questions = [

					{prompt: 
					'As you noticed, the '+ iConcept.concept_object + 's in phase 1 differed from each other by the size of their '+ 
					iConcept.dim1_name + ' and '+ iConcept.dim2_name + '. ' + 
					'<br>Imagine drawing a 2-dimensional space, where the dimensions are the size of '+ iConcept.dim1_name + ' and '+ 
					iConcept.dim2_name + ',' +
					' just like in the image above. <br> Every point in that space has coordinates along each of the two dimensions. '+ 
					'Thus, every '+ iConcept.concept_object + ' with a certain size of '+ iConcept.dim1_name + ' and '+ 
					iConcept.dim2_name + ','+
					' can be represented as a point in this 2-dimensional space. <br> Every toy that was "hidden" by a '+ 
					iConcept.concept_object + 
					' with a particular size of '+ iConcept.dim1_name + ' and '+ iConcept.dim2_name + 
					', is thus "located" at the same spot as the '+ iConcept.concept_object + ' in this 2-dimensional space.' + 
					'<br>At any point during the experiment, did you realize that the '+ 
					iConcept.concept_object + 's and their toys could be characterized as locations in such a 2-dimensional space? ' +
					'<br> If you did realize this, did this help you in learning the '+ 
					iConcept.concept_object + '-toy associations?' + 
					'<br> If this question is unclear and does not explain well what is meant by this 2-dimensional representation, please indicate below.', 
					rows: 3, columns: 100, placeholder: ''},            
				]
			let spatial_preamble = '<p style="font-size: 30px;"><b>Phase '+ iPhase + ' debriefing about the '+ iConcept.concept_object + 's:</b></p>'

			// A tag that will be added to the trial, will let us see in the results what this page was for
			let tag = {test_part: 'phase_' + iPhase + '_spatial_layout'}
			
			let spatialLayoutPage = createImageSurveyTrial(spatial_preamble,[spatialLayoutImgEl],spatial_questions,tag)
			
			// Which imgs to preload?
			imgs_to_preload.push(spatialLayoutImgEl.src)

			return spatialLayoutPage
		};

		const createRealizeMappingDebriefer = function(){

			let concept_1 = jatos.studySessionData.inputData.concepts.phase_1
			let concept_2 = jatos.studySessionData.inputData.concepts.phase_2	

			// Which PA to use?
			let targetPath_1 = jatos.studySessionData.inputData.basic_parameters.targetPathsUsed.phase_1[0]
			let targetPath_2 = jatos.studySessionData.inputData.basic_parameters.targetPathsUsed.phase_2[0]
			
			let targetName_1 = jatos.studySessionData.inputData.basic_parameters.targetNamesUsed.phase_1[0]		

			let idxOfTarget_1 = jatos.studySessionData.inputData.basic_parameters.targetPoints.phase_1[0]
			let idxOfTarget_2 = jatos.studySessionData.inputData.basic_parameters.targetPoints.phase_2[0]			
			
			let pa_box_width, pa_box_height 
			pa_box_width = pa_box_height = jatos.studySessionData.inputData.basic_parameters.pa_box_width

			let exemplar_1_width = jatos.studySessionData.inputData.concepts.phase_1.single_ex_img_width * (pa_box_width-90) / jatos.studySessionData.inputData.basic_parameters.sort_area_width * 1.6
			let exemplar_2_width = jatos.studySessionData.inputData.concepts.phase_2.single_ex_img_width * (pa_box_width-90) / jatos.studySessionData.inputData.basic_parameters.sort_area_width * 1.6

			// Wrapper flex element
			let wrapperFlexEl  					   = document.createElement('div')
			wrapperFlexEl.style.display            = 'flex'
			wrapperFlexEl.style['justify-content'] = 'center'
			wrapperFlexEl.style['align-items']     = 'center'        

			// Image showing an example PA from phase 1
			let paEl_1                       = document.createElement('div')
			paEl_1.style.display             = 'flex'
			paEl_1.style['flex-direction']   = concept_1.debrief_flex_dir
			paEl_1.style['justify-content']  = 'center'
			paEl_1.style['align-items']      = 'center'
			paEl_1.id                        = 'example_pa1'
			paEl_1.style.border              = '1px solid'
			paEl_1.style.height              = pa_box_height + 'px'
			paEl_1.style.width               = pa_box_width  + 'px'
			paEl_1.style['background-color'] = 'white'
			paEl_1.style.margin              = '20px'

			// Image showing an example PA from phase 2
			paEl_2 = paEl_1.cloneNode(true)
			paEl_2.id = 'example_pa2'
			paEl_2.style['flex-direction']   = concept_2.debrief_flex_dir

			// Make the concept exemplar elements
			let exemplarEl_1          = document.createElement('img')
			exemplarEl_1.id           = 'exemplarEl_1'
			exemplarEl_1.src          = './img/' + jatos.studySessionData.inputData.concepts.phase_1.concept_space + '/individual_imgs/stim_'+idxOfTarget_1+'.png'
			exemplarEl_1.style.width = exemplar_1_width+'px'   

			exemplarEl_2              = exemplarEl_1.cloneNode(true)
			exemplarEl_2.id           = 'exemplarEl_2'
			exemplarEl_2.src          = './img/' + jatos.studySessionData.inputData.concepts.phase_2.concept_space + '/individual_imgs/stim_'+idxOfTarget_1+'.png'
			exemplarEl_2.style.width = exemplar_2_width+'px'   

			// Make the toys
			let toyElement_1          = document.createElement('img')
			toyElement_1.id           = 'toy_1'
			toyElement_1.src          = targetPath_1
			toyElement_1.style.height = '50px'

			toyElement_2     = toyElement_1.cloneNode(true)
			toyElement_2.id  = 'toy_2'
			toyElement_2.src = targetPath_2

			// Append all the elements to the flex box
			paEl_1.appendChild(exemplarEl_1)
			paEl_1.appendChild(toyElement_1)
			paEl_2.appendChild(exemplarEl_2)
			paEl_2.appendChild(toyElement_2)	

			wrapperFlexEl.appendChild(paEl_1)
			wrapperFlexEl.appendChild(paEl_2)						

			let realize_mapping_questions = [
					{prompt: 'During phase 2, did you realize that there is a relationship between the '+ concept_1.concept_object+'s ' + 
					'that hide the toys in phase 1 and '+ concept_2.concept_object+'s that hide toys in phase 2? <br> ' + 
					'For example, if a phase-1 '+ concept_1.concept_object+' with a certain '+ concept_1.dim1_name+':'+ concept_1.dim2_name+' ratio was hiding the '+targetName_1+' (as shown above), ' + 
					'the phase-2 '+ concept_1.concept_object+' that was hiding the '+targetName_1+' also had a similar ratio of '+ concept_2.dim1_name+':'+ concept_2.dim2_name+'.' +
					' The same was true for the other toys.' + 
					'<br> If you did realize this, did this help you in performing during phase 2? If so, how did it help you? Please describe.', rows: 3, columns: 100, placeholder: ''},            
				]
			let realize_mapping_preamble = '<p style="font-size: 30px;"><b>Phase 1 / Phase 2 debriefing:</b></p>'
			
			// A tag that will be added to the trial, will let us see in the results what this page was for
			let tag = {test_part: 'realize_mapping_page'}

			let realize_mapping_page = createImageSurveyTrial(realize_mapping_preamble,[wrapperFlexEl],realize_mapping_questions,tag)
			
			// Which images to preload? Add the exemplar and toy images
			imgs_to_preload.push(exemplarEl_1.src, exemplarEl_2.src, toyElement_1.src, toyElement_2.src)

			return realize_mapping_page
		};

		////////////////////////////////////////////////////////////////////////////////////////

		// What phase is this?
		let [curr_phase,phase_string,curr_session] = getPhaseAndSession()

		let trial_dur_sec = jatos.studySessionData.timer_response_window / 1000

		// Create the score box
		let score_box_element = createScoreBox()
		score_box_element.style.margin = '0 auto'

		let component_to_start

		//make a timeline
		var timeline = []; 
		
		// preload imgs in case defriefing page contains them. Start already with the target items
		let imgs_to_preload = [...jatos.studySessionData.inputData.basic_parameters.targetPathsUsed[phase_string]]; 

		// Generic message saying "sorry you failed QC". Will then be followed by appropriate debriefing pages, and data submission
		var qc_failed_generic_page = {

			type: 'instructions',
			pages : [				
					'<div class="instruct">'+
						'<p> Unfortunately, your performance did not pass our quality checks. </p> ' + 
						'<p> As we stated in the instructions, in such case we have to discontinue the study. </p>' +
						'<p> You will be paid for completing the study up to this stage. </p> ' + 
						'<p> But first, please complete the debriefing survey by clicking the "Debrief" button.</p>' +
					'</div>'
					],
			show_clickable_nav: true,
			button_label_next: '<span style="color: black"d;> <strong> Debrief </stong></span>',
			allow_backward: false,
			data: {test_part: 'qc_failed_generic_page'},
		};

		// In case they fail at the instructions or the practice trials
		var qc_failed_instr_practice_page = {

			type: 'instructions',
			pages : [				
					'<div class="instruct">'+
						'<p> Unfortunately, your performance did not pass our quality checks. </p> ' + 
						'<p> As we stated in the instructions, in such case we have to discontinue the study. </p>' +
						'<p> You will be paid for completing the study up to this stage. </p> ' + 
					'</div>'
					],
			show_clickable_nav: true,
			button_label_next: '<span style="color: black"d;> <strong> Continue </stong></span>',
			allow_backward: false,
			data: {test_part: 'qc_failed_instr_practice_page'},
		};

		// Generic message saying thank you for training please answer debrief
		var training_finished_generic_page = {

			type: 'instructions',
			pages : [				
					'<div class="instruct">'+
						'<p> Thank you very much! You have completed the training! </p> ' +  
						'<p> Below you can see your finishing scores for phase ' + curr_phase + ': </p>' +
						score_box_element.outerHTML + 
						'<p> Please complete the debriefing survey by clicking the "Debrief" button.</p>' +
						'<p> After that, the experiment is over. Thank you! </p>'+
					'</div>'
					],
			show_clickable_nav: true,
			button_label_next: '<span style="color: black"d;> <strong> Debrief </stong></span>',
			allow_backward: false,
			data: {test_part: 'training_finished_generic_page'},
		};		

		// Generic message saying thank you for training please answer debrief
		var debriefing_finished_generic_page = {

			type: 'instructions',
			pages : [				
					'<div class="instruct">'+
						'<p> Click "Finish Experiment" below to submit your data and be redirected to prolific! </p> ' +  
						'<p> Thank you! </p>'+
					'</div>'
					],
			show_clickable_nav: true,
			button_label_next: '<span style="color: black"d;> <strong> Finish Experiment </stong></span>',
			data: {test_part: 'debriefing_finished_generic_page'},
		};				

		// Generic questions to ask regardless of where the ptp failed, or if the ptp succeeded
        var general_questions_page = {
            type: 'survey-text',
			questions: [
                {prompt: 'Were the game instructions clear? If not, please help us improve them.', rows: 3, columns: 100},
                {prompt: 'Was the number of toys you had to "find" too high? Should we make it less or more?', rows: 3, columns: 100},
                {prompt: 'Were '+ trial_dur_sec +' seconds enough on each trial to make your choice and learn from feedback?', rows: 3, columns: 100},
                {prompt: 'Did you complete the experiment in fullscreen mode? (You will not be penalised if you did not. We just need to know).', rows: 3, columns: 100},
                {prompt: 'Is there anything that would make the game easier or more fun?', rows: 3, columns: 100},                
                ],
			button_label: 'Continue',
			preamble: '<p style="font-size: 30px;"><b>Please answer the following questions:</b></p>',
			data: {test_part: 'general_questions_page'},
		};		
		
		// Questions to ask for any specific phase
			// Phase 1
			var phase_1_questions_page = createPhaseDebriefer(1,jatos.studySessionData.inputData.concepts.phase_1)
			// Phase 2
			var phase_2_questions_page = createPhaseDebriefer(2,jatos.studySessionData.inputData.concepts.phase_2)

		// Element asking about the spatial layout.
			// Phase 1
			var phase_1_spatial_page = createSpatialLayoutDebriefer(1,jatos.studySessionData.inputData.concepts.phase_1)
			// Phase 2
			var phase_2_spatial_page = createSpatialLayoutDebriefer(2,jatos.studySessionData.inputData.concepts.phase_2)

		// Realize phase 3 was a repeat of 1? Relearn or remember?
		var phase_3_was_1_page = {

			type: 'survey-text',
			questions: [
				{prompt: 'For phase 3, did you realize that the same '+jatos.studySessionData.inputData.concepts.phase_3.concept_object+'s were hiding the same toys as in phase 1?', rows: 3, columns: 100},
				{prompt: 'Did your phase 1 knowledge of which '+jatos.studySessionData.inputData.concepts.phase_1.concept_object+' was hiding which toy help you in phase 3? <br> Or did you have to re-learn the associations for phase 3 from scratch?', rows: 3, columns: 100},				
			],
			button_label: 'Continue',
			preamble: '<p style="font-size: 30px;"><b>Phase 3 and phase 1 relationship:</b></p>',
			data: {test_part: 'phase_3_was_1_page'},
		};


		// Realize mapping?
		var realize_mapping_page = createRealizeMappingDebriefer()

		// For short break
		var short_break_page = {
			type: 'instructions-timer',
			pages: [
				'<p> Thank you so much for completing this session! <br> ' + 
				'We really appreciate you staying attentive and continuing to honestly perform the task. </p>' +
				'<p> Below you can see your scores from the last session: </p>' +
				score_box_element.outerHTML + 
				'<p> <br>Remember, you goal is to reach ' + 
					jatos.studySessionData.training_criterion + '% on finding the '+
					jatos.studySessionData.inputData.concepts[phase_string].concept_object+'s hiding each of these toys!' +
				'<p><br> Please take a ' + jatos.studySessionData.short_break_duration + 
				' second break and click the Next button or press the right-arrow button on the keyboard to start the next session. </p>'
			],
			show_clickable_nav: true,
			button_label_next: "<span style='color: blue';> <strong> Next </stong></span>",
			n_seconds: jatos.studySessionData.short_break_duration,
			data: {test_part: 'short_break_page'},
		};

		// For long break
		var long_break_page = {
			type: 'instructions-timer',
			pages: [
				'<p> Congratulations! You have finished phase ' + curr_phase + ' of the game! </p>' + 
				'<p> Below you can see your finishing scores for phase ' + curr_phase + ': </p>' +
				score_box_element.outerHTML + 
				'<p> Please take a ' + jatos.studySessionData.short_break_duration + 
				' second break, and then click the Next button to read instructions for phase ' + 
				(curr_phase+1) + '!</p>' +
				'<p> Thank you very much for staying attentive! </p>'
			],
			show_clickable_nav: true,
			button_label_next: "<span style='color: blue';> <strong> Next </stong></span>",
			n_seconds: jatos.studySessionData.long_break_duration,
			data: {test_part: 'long_break_page'},
		};

		let show_progress_bar = false

		if (jatos.studySessionData.progress_state == 'starting'){

			jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.post_practice_instructions)

		} else if (jatos.studySessionData.progress_state == 'advance_phase') {
			timeline.push(long_break_page)

			jatos.studySessionData.phase_counter ++

			component_to_start = jatos.studySessionData.script_comp_pos.instructions

		} else if (jatos.studySessionData.progress_state == 'advance_session'){
			timeline.push(short_break_page)
			jatos.studySessionData.session_counter[phase_string] ++			

			component_to_start = jatos.studySessionData.script_comp_pos.phase_pa

		} else if (jatos.studySessionData.progress_state == 'qc_failed_instructions' ||
				   jatos.studySessionData.progress_state == 'qc_failed_practice'){
			timeline.push(qc_failed_instr_practice_page)
			timeline.push(debriefing_finished_generic_page)

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission

		} else if (jatos.studySessionData.progress_state == 'qc_failed_phase_1'){			
			timeline.push(qc_failed_generic_page)
			timeline.push(general_questions_page)
			timeline.push(phase_1_questions_page)
			timeline.push(phase_1_spatial_page)
			timeline.push(debriefing_finished_generic_page)

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission

			show_progress_bar = true

		} else if (jatos.studySessionData.progress_state == 'qc_failed_phase_2'){		
			timeline.push(qc_failed_generic_page)
			timeline.push(general_questions_page)
			timeline.push(phase_1_questions_page)
			timeline.push(phase_2_questions_page)

			// Realize mapping?
			if (jatos.studySessionData.inputData.congruency){
				timeline.push(realize_mapping_page)
			}

			timeline.push(phase_1_spatial_page)
			timeline.push(phase_2_spatial_page)			
			timeline.push(debriefing_finished_generic_page)


			component_to_start = jatos.studySessionData.script_comp_pos.data_submission

			show_progress_bar = true

		} else if (jatos.studySessionData.progress_state == 'qc_failed_phase_3'){
			timeline.push(qc_failed_generic_page)
			timeline.push(general_questions_page)
			timeline.push(phase_1_questions_page)
			timeline.push(phase_2_questions_page)

			// Realize mapping?
			if (jatos.studySessionData.inputData.congruency){
				timeline.push(realize_mapping_page)
			}

			timeline.push(phase_1_spatial_page)
			timeline.push(phase_2_spatial_page)	
			timeline.push(phase_3_was_1_page)
			timeline.push(debriefing_finished_generic_page)

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission

			show_progress_bar = true

		} else if (jatos.studySessionData.progress_state == 'finished_training'){		
			timeline.push(training_finished_generic_page)
			timeline.push(general_questions_page)
			timeline.push(phase_1_questions_page)
			timeline.push(phase_2_questions_page)

			// Realize mapping?
			if (jatos.studySessionData.inputData.congruency){
				timeline.push(realize_mapping_page)
			}

			timeline.push(phase_1_spatial_page)
			timeline.push(phase_2_spatial_page)	
			timeline.push(phase_3_was_1_page)
			timeline.push(debriefing_finished_generic_page)

			component_to_start = jatos.studySessionData.script_comp_pos.data_submission

			show_progress_bar = true
		} // checking progress state		
		
		if (!jatos.studySessionData.progress_state.includes('starting')){
			jsPsych.init({

				timeline: timeline,
				show_progress_bar: show_progress_bar,
				preload_images: imgs_to_preload,

				on_finish: function() {
					
					// If its a transition between sessions or phases, record in the transitions_results object
					if (jatos.studySessionData.progress_state == 'advance_phase' || 
						jatos.studySessionData.progress_state == 'advance_session'){
						let idx = jatos.studySessionData.outputData[phase_string + '_transitions_results'].length
						jatos.studySessionData.outputData[phase_string + '_transitions_results'][idx] = jsPsych.data.get().values();	
					// If its debrief, record in the debrief object
					} else {
						let idx = jatos.studySessionData.outputData[phase_string + '_debrief_results'].length
						jatos.studySessionData.outputData[phase_string + '_debrief_results'][idx] = jsPsych.data.get().values();	
					}

					jatos.submitResultData("[transition_start---" + 
					JSON.stringify(jatos.studySessionData) + 
					"---transition_end]", function(){
						jatos.startComponentByPos(component_to_start);
					});
				}
			});
		}
	});

	</script>
</body>
</html>