<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Check for QC</title>
  <script src = "../dissimilarity_test/extra_functions/jquery-3.4.1.js" type="text/javascript"></script>
  <script src="./jspsych-6.1.0/jspsych.js"></script>
  <link href="./jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  <script src="jatos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-combinatorics@0.5"></script>
  <script src='./jspsych-6.1.0/plugins/jspsych-survey-text.js'></script>
  <script src="./extra_functions/helper_functions.js"> </script>
 
  <style>	body {background-color: #b9c6c7; font-family: sans-serif; color: black;} </style>
	<style> p {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px;} </style>
	<style> ul {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px; cursor:default;} </style>
	<style> .instruct{width:100%; color: black; text-align:center; cursor:default;} </style>
	<style> .header {position: fixed; left:0; top:0; width:100%; background-color:#8f8d8d; color: white; text-align: center;cursor:default;} </style>
 
</head>

<body></body>

<script>


  jatos.onLoad(function() {

    // What phase is this?
    let [curr_phase,phase_string,curr_session] = getPhaseAndSession() 
    
    // ////////////////////////////////////////////// START CHECKS //////////////////////////////////////////////////////////////

    // Get the latest data
    let last_session_data = jatos.studySessionData.last_session_data

    if (curr_phase == 1){

      if (jatos.studySessionData.latestFinishedComponentTitle.includes('practice')){
        
        // Are we checking practice trials?

        // Check instructions weren't breezed through too fast
        
        // Check RTs not too low. Also checks that not all trials were missed
        let rt_speed_pass_practice = last_session_data.some(item => item.rt > jatos.studySessionData.qc_criteria.rt_min_speed)

        // record in the jatos object
        jatos.studySessionData.qc_status.practice_pass = rt_speed_pass_practice

        if (!rt_speed_pass_practice){
          // Record global pass failure
          jatos.studySessionData.qc_status.global_pass = false
          jatos.studySessionData.progress_state = 'qc_failed_practice'
        } else {
          // So didn't fail
          jatos.submitResultData('Phase 1 practice QC passed. Starting post practice instructions', 
            jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.post_practice_instructions))
        }

      } else {

        //  //////// Checking real sessions of phase 1 ////////////
        // ////////////////////////////////////////////////////////

        // This function will check all the qc criteria, and determine what to do next
        session_qc_check(last_session_data)

        // Start the break script
        jatos.submitResultData(`Phase ${curr_phase} session ${curr_session} QC.`, 
          jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.break))

      } // Checking the real sessions section

    } else {

      // So its phase 2+ //////////////////////////////////////////////////////////////////////////////////////////    
    
      // This function will check all the qc criteria, and determine what to do next
      session_qc_check(last_session_data)

      // Start the break script
      jatos.submitResultData(`Phase ${curr_phase} session ${curr_session} QC passed. Giving a break`, 
        jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.break))

    } // phase bracket

  }); // jatos IFFY


</script>

</html>