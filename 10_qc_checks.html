<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Check for QC</title>
  <script src = "../dissimilarity_test/extra_functions/jquery-3.4.1.js" type="text/javascript"></script>
  <script src="./jspsych-6.1.0/jspsych.js"></script>
  <link href="./jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  <script src="jatos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-combinatorics@0.5"></script>
  <script src='./jspsych-6.1.0/plugins/jspsych-survey-text.js'></script>
  <script src="./extra_functions/custom_functions.js"> </script>
 
  <style>	body {background-color: #b9c6c7; font-family: sans-serif; color: black;} </style>
	<style> p {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px;} </style>
	<style> ul {font-size: 125%; margin-top:0px; margin-right:100px; margin-bottom:20px; margin-left: 100px; cursor:default;} </style>
	<style> .instruct{width:100%; color: black; text-align:center; cursor:default;} </style>
	<style> .header {position: fixed; left:0; top:0; width:100%; background-color:#8f8d8d; color: white; text-align: center;cursor:default;} </style>
 
</head>

<body></body>

<script>


  jatos.onLoad(function() {

    let session_qc_check = function(last_session_data,curr_session){
      
      // 1. Not too many missed trials
      let n_missed_trials    = last_session_data.filter(item => item.rt==null).length
      let perc_missed_trials = n_missed_trials * 100 / last_session_data.length
  
      if (perc_missed_trials >= jatos.studySessionData.qc_criteria.perc_max_missed){
        jatos.studySessionData.qc_status.perc_max_missed_pass = false
        jatos.studySessionData.qc_status.global_pass          = false            
      }
  
      // 2. Not too many fast trials
      let n_fast_trials    = last_session_data.filter(item => item.rt < jatos.studySessionData.qc_criteria.rt_min_speed).length
      let perc_fast_trials = n_fast_trials * 100 / last_session_data.length
  
      if (perc_fast_trials >= jatos.studySessionData.qc_criteria.rt_min_perc){
        jatos.studySessionData.qc_status.rt_pass     = false
        jatos.studySessionData.qc_status.global_pass = false            
      }
  
      // 3. Not too many similar responses
  
      // Get the bin counts
      let bin_counts = [];
      let responded_trials = last_session_data.filter(item => item.rt !== null);
  
      // debugger
      for (iElement = 0; iElement < jatos.studySessionData.inputData.choices.length; iElement++){
        bin_counts[iElement] = responded_trials.filter(item => item.key_press == ['49','50'][iElement]).length;
      }
      let max_count = Math.max(...bin_counts);
      let max_perc = max_count * 100 / responded_trials.length
  
      if (max_perc >= jatos.studySessionData.qc_criteria.uniform_resp_perc){
  
        jatos.studySessionData.qc_status.global_pass            = false;
        jatos.studySessionData.qc_status.uniform_resp_perc_pass = false;
  
      }
  
      // 4. If session >= 2, check better than chance
      if (curr_session >= 2){
  
        let n_targets_above_chance = 
          jatos.studySessionData.inputData.score_box_target_paths.running_perf.filter(item => item > 
            jatos.studySessionData.qc_criteria.min_perf_check_perc).length
  
        if (n_targets_above_chance < jatos.studySessionData.inputData.basic_parameters.nTargets) {
          jatos.studySessionData.qc_status.global_pass   = false;
          jatos.studySessionData.qc_status.min_perf_pass = false;
        }
      }
    }

    // What phase is this?
    let curr_phase   = jatos.studySessionData.phase_counter
    let phase_string = 'phase_'+curr_phase
    let curr_session = jatos.studySessionData.session_counter[phase_string]

    var timeline = []

    // In case the ptp failed qc after phase 1 practice
    var qc_failed_practice = {

      type: 'survey-text',
      questions: jatos.studySessionData.debrief_questions,
      button_label: "Finish",
      preamble: "<p> <br> Unfortunately, your performance did not pass our quality checks. </p> " + 
          "<p> As we stated in the instructions, in such a case we have to discontinue the study. </p>" +
          "<p> You will still be paid 1.2 pounds for completing the instructions and the practice session. </p> " + 
          "<p> But first, please answer the following questions and then click the 'Finish' button below.</p>"
      };

    // In case they failed qc
    var qc_failed_phase_1 = {

      type: 'survey-text',
      questions: jatos.studySessionData.debrief_questions,
      button_label: "Finish",
      preamble: "<p> Unfortunately, your performance did not pass our quality checks. </p> " + 
                "<p> As we stated in the instructions, in such a case we have to discontinue the study. </p>" +
                "<p> You will still be paid for the practice session and any completed experimental session.</p> " + 
                "<p> But first, please answer the following questions and then click the 'Finish' button below.</p>"

    };  

    var qc_failed_phase_2 = {

      type: 'survey-text',
      questions: jatos.studySessionData.debrief_questions,
      button_label: "Finish",
      preamble: "<p> Unfortunately, your performance did not pass our quality checks. </p> " + 
                "<p> As we stated in the instructions, in such a case we have to discontinue the study. </p>" +
                "<p> You will still be paid for the practice session and any completed experimental session.</p> " + 
                "<p> But first, please answer the following questions and then click the 'Finish' button below.</p>"

    };      

    // Get the latest data
    let last_session_data = jatos.studySessionData.last_session_data

    if (curr_phase == 1){

      if (jatos.studySessionData.latestFinishedComponentTitle.includes('practice')){
        
        // Are we checking practice trials?

        // Check instructions weren't breezed through too fast
        
        // Check RTs not too low
        let rt_speed_pass_practice = false
        last_session_data.forEach((item) => {
          if (item.rt > jatos.studySessionData.qc_criteria.rt_min_speed){
            rt_speed_pass_practice = true
          }
        })

        // record in the jatos object
        jatos.studySessionData.qc_status.practice_pass = rt_speed_pass_practice

        if (!rt_speed_pass_practice){

          // Record global pass failure
          jatos.studySessionData.qc_status.global_pass = false

          timeline.push(qc_failed_practice)

          jsPsych.init({
              timeline: timeline,
              on_finish: function(data){
                  jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.data_submission);
              }
          })
        } else {
          // So didn't fail
          jatos.submitResultData('Phase 1 practice QC passed. Starting post practice instructions', 
            jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.post_practice_instructions))
        }
      } else {
        // Checking real sessions
        // debugger
        session_qc_check(last_session_data,curr_session)

        // Has the ptp failed?
        if (jatos.studySessionData.qc_status.global_pass == false){

          // Debrief only for phase 1
          timeline.push(qc_failed_phase_1)
          
          jsPsych.init({
            timeline: timeline,
            on_finish: function(data){
                // jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.data_submission);
                jsPsych.data.displayData();

            }
          }) 

        } else {

          // So didn't fail

            // Check, if exceeded the performance, then continue to phase 2
            let n_targets_learned = 
              jatos.studySessionData.inputData.score_box_target_paths.running_perf.filter(item => item >= 
                jatos.studySessionData.training_criterion).length

            if (n_targets_learned == jatos.studySessionData.inputData.basic_parameters.nTargets) {
              // Iterate the phase 
              jatos.studySessionData.phase_counter ++
              // Reset the session
              jatos.studySessionData.session_counter = 1
            } else {
              // Iterate session
              jatos.studySessionData.session_coutner ++
            }

            // Give a break
            jatos.submitResultData(`Phase ${curr_phase} session ${curr_session} QC passed. Giving a break`, 
              jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.short_break))



        } // global pass fail? if/else section


      } // Checking the real sessions section

    } else {

      // So its phase 2

      if (jatos.studySessionData.latestFinishedComponentTitle.includes('practice')){
      // Are we checking practice trials?

      // If this is phase 2, then don't check practice trials. Ptps are probably very fast on everything.
      jatos.submitResultData('Phase 2, practice done. Not checking QC.', 
      jatos.startComponentByPos(jatos.studySessionData.script_comp_pos.post_practice_instructions))


      } else {




      }

    }
    

    // Get the data from the last session:


    // Check the RTs

    // Check if all responses are the same

    // If session 2: check that response rate is > 50%

    // Check the overall performance.

        // If more than 80% on each PA

            // Congratulate, start the next phase.

        // If less than 80% on each PA

            // Encourage and give a break



  });


</script>

</html>